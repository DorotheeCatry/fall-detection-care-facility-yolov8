{% extends "base.html" %}

{% block title %}Fall Alerts Dashboard{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
  <h1 class="text-2xl font-bold text-gray-900 mb-4 sm:mb-0">Fall Alerts Dashboard</h1>
  <a href="{% url 'detection:test_detection' %}" class="btn-primary flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2"
         viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd"
            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            clip-rule="evenodd" />
    </svg>
    Test Detection
  </a>
</div>

{% if messages %}
  <div class="mb-6">
    {% for message in messages %}
      <div class="p-4 {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200
                       {% elif message.tags == 'error'   %}bg-red-50   text-red-800   border border-red-200
                       {% else                        %}bg-blue-50  text-blue-800  border border-blue-200{% endif %} rounded-md mb-2">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<form method="get" class="mb-6 flex flex-wrap gap-4 items-center">
  <label class="inline-flex items-center text-sm text-gray-700">
    <input type="checkbox"
           name="include_tests"
           value="1"
           class="form-checkbox"
           {% if include_tests %}checked{% endif %}
           onchange="this.form.submit()">
    <span class="ml-2">Include Test Uploads</span>
  </label>
  <label>
    <span class="text-xs text-gray-600">Date:</span>
    <input type="date" name="date" value="{{ request.GET.date }}" class="form-input text-xs px-2 py-1 border rounded" onchange="this.form.submit()">
  </label>
  <label>
    <span class="text-xs text-gray-600">Hour:</span>
    <input type="time" name="hour" value="{{ request.GET.hour }}" class="form-input text-xs px-2 py-1 border rounded" onchange="this.form.submit()">
  </label>
  <label>
    <span class="text-xs text-gray-600">Detected By:</span>
    <select name="detected_by" multiple class="form-select text-xs px-2 py-1 border rounded" onchange="this.form.submit()">
      {% for val in detected_by_options %}
        <option value="{{ val }}" {% if val in detected_by_selected %}selected{% endif %}>{{ val }}</option>
      {% endfor %}
    </select>
  </label>
  <label>
    <span class="text-xs text-gray-600">Status:</span>
    <select name="status" multiple class="form-select text-xs px-2 py-1 border rounded" onchange="this.form.submit()">
      <option value="acknowledged" {% if 'acknowledged' in status_selected %}selected{% endif %}>Acknowledged</option>
      <option value="new" {% if 'new' in status_selected %}selected{% endif %}>New</option>
    </select>
  </label>
  <button type="submit" class="btn-primary text-xs px-3 py-1">Apply</button>
  <a href="{% url 'detection:alerts' %}" class="btn-secondary text-xs px-3 py-1">Reset Filters</a>
</form>

{% if alerts %}
  <div class="bg-white shadow-md rounded-lg overflow-hidden mb-6">
    <div class="overflow-x-auto">
      <table id="alerts-table" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable">
              <a href="?sort=timestamp&order={% if request.GET.sort == 'timestamp' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="flex flex-col items-start">
                Timestamp
                <span>
                  <span class="block text-xs {% if request.GET.sort == 'timestamp' and request.GET.order == 'asc' %}text-blue-600{% endif %}">▲</span>
                  <span class="block text-xs {% if request.GET.sort == 'timestamp' and request.GET.order == 'desc' %}text-blue-600{% endif %}">▼</span>
                </span>
              </a>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable">
              Detected By
              <span class="sort-arrows">
                <span class="arrow-up" style="cursor:pointer;">▲</span>
                <span class="arrow-down" style="cursor:pointer;">▼</span>
              </span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable">
              Description
              <span class="sort-arrows">
                <span class="arrow-up" style="cursor:pointer;">▲</span>
                <span class="arrow-down" style="cursor:pointer;">▼</span>
              </span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable">
              Confidence
              <span class="sort-arrows">
                <span class="arrow-up" style="cursor:pointer;">▲</span>
                <span class="arrow-down" style="cursor:pointer;">▼</span>
              </span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable">
              Status
              <span class="sort-arrows">
                <span class="arrow-up" style="cursor:pointer;">▲</span>
                <span class="arrow-down" style="cursor:pointer;">▼</span>
              </span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Action
            </th>
          </tr>
          <tr class="bg-gray-100">
            <th class="px-6 py-2">
              <select data-col="0" class="form-select w-full text-xs filter-dropdown"><option value="">All</option></select>
            </th>
            <th class="px-6 py-2">
              <select data-col="1" class="form-select w-full text-xs filter-dropdown"><option value="">All</option></select>
            </th>
            <th class="px-6 py-2">
              <select data-col="2" class="form-select w-full text-xs filter-dropdown"><option value="">All</option></select>
            </th>
            <th class="px-6 py-2">
              <select data-col="3" class="form-select w-full text-xs filter-dropdown"><option value="">All</option></select>
            </th>
            <th class="px-6 py-2">
              <select data-col="4" class="form-select w-full text-xs filter-dropdown"><option value="">All</option></select>
            </th>
            <th class="px-6 py-2"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for alert in alerts %}
            <tr class="{% if not alert.acknowledged %}bg-red-50 bg-opacity-30{% endif %}">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ alert.timestamp|date:"Y-m-d H:i" }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if alert.detected_by == 'live_camera' %}
                  <span class="inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-4 w-4 mr-1 text-blue-500"
                         viewBox="0 0 20 20" fill="currentColor">
                      <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6z
                               M14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7
                               a1 1 0 00-1.447-.894l-2 1z" />
                    </svg>
                    Live Camera
                  </span>
                {% elif alert.detected_by == 'test_upload' %}
                  <span class="inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-4 w-4 mr-1 text-purple-500"
                         viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z
                               M6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3
                               a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414
                               L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Test Upload
                  </span>
                {% else %}
                  {{ alert.detected_by|default:"–" }}
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if alert.detected_by == 'live_camera' %}
                  Fall detected via YOLOv8
                {% else %}
                  {{ alert.description|default:"–" }}
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if alert.yolo_confidence is not None %}
                  {{ alert.yolo_confidence|floatformat:1 }}%
                {% else %}
                  –
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {% if alert.acknowledged %}
                  <span class="badge-acknowledged">Acknowledged</span>
                {% else %}
                  <span class="badge-new">New</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                {% if not alert.acknowledged %}
                  <form method="post" action="{% url 'detection:acknowledge_alert' alert.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-success text-sm">Acknowledge</button>
                  </form>
                {% else %}
                  <span class="text-gray-400">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if is_paginated %}
    <div class="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow-sm">
      <div class="flex flex-1 justify-between sm:hidden">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if include_tests %}&include_tests=1{% endif %}"
             class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
            Previous
          </a>
        {% else %}
          <span class="inline-flex items-center rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-500">
            Previous
          </span>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if include_tests %}&include_tests=1{% endif %}"
             class="ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
            Next
          </a>
        {% else %}
          <span class="ml-3 inline-flex items-center rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-500">
            Next
          </span>
        {% endif %}
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <p class="text-sm text-gray-700">
          Showing <span class="font-medium">{{ page_obj.start_index }}</span>
          to <span class="font-medium">{{ page_obj.end_index }}</span>
          of <span class="font-medium">{{ paginator.count }}</span> alerts
        </p>
        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if include_tests %}&include_tests=1{% endif %}"
               class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              <span class="sr-only">Previous</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0
                         11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75
                         0 011.06.02z"
                      clip-rule="evenodd"/>
            </a>
          {% else %}
            <span class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-300 ring-1 ring-inset ring-gray-300">
              <span class="sr-only">Previous</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0
                         11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75
                         0 011.06.02z"
                      clip-rule="evenodd"/>
            </span>
          {% endif %}
          {% for i in paginator.page_range %}
            {% if page_obj.number == i %}
              <span class="relative z-10 inline-flex items-center bg-blue-600 px-4 py-2 text-sm font-semibold text-white">
                {{ i }}
              </span>
            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
              <a href="?page={{ i }}{% if include_tests %}&include_tests=1{% endif %}"
                 class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                {{ i }}
              </a>
            {% endif %}
          {% endfor %}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if include_tests %}&include_tests=1{% endif %}"
               class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
              <span class="sr-only">Next</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0
                         111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75
                         0 01-1.06-.02z"
                      clip-rule="evenodd"/>
            </a>
          {% else %}
            <span class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-300 ring-1 ring-inset ring-gray-300">
              <span class="sr-only">Next</span>
              <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0
                         111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75
                         0 01-1.06-.02z"
                      clip-rule="evenodd"/>
            </span>
          {% endif %}
        </nav>
      </div>
    </div>
  {% endif %}
{% else %}
  <div class="bg-white shadow-md rounded-lg p-6 text-center">
    <h3 class="text-lg font-medium text-gray-900 mb-1">No alerts found</h3>
    <p class="text-gray-500 mb-4">There are currently no fall alerts in the system.</p>
    <a href="{% url 'detection:test_detection' %}" class="btn-primary inline-flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
              d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
              clip-rule="evenodd"/>
      </svg>
      Test Detection
    </a>
  </div>
{% endif %}

<!-- Tablesort for clickable sorting -->
<script src="https://cdn.jsdelivr.net/npm/tablesort@5.2.1/dist/tablesort.min.js"></script>
<script>
  // initialize Tablesort on our table
  const table = document.getElementById('alerts-table');
  new Tablesort(table);

  // Add sorting on arrow click
  document.querySelectorAll('.sortable .arrow-up').forEach((arrow, idx) => {
    arrow.addEventListener('click', () => Tablesort.sortTable(table, idx, true));
  });
  document.querySelectorAll('.sortable .arrow-down').forEach((arrow, idx) => {
    arrow.addEventListener('click', () => Tablesort.sortTable(table, idx, false));
  });

  // Helper: get unique values for a column
  function getUniqueColumnValues(colIdx) {
    const values = new Set();
    table.querySelectorAll('tbody tr').forEach(tr => {
      const cell = tr.children[colIdx];
      if (cell) values.add(cell.textContent.trim());
    });
    return Array.from(values).sort();
  }

  // Populate dropdowns with unique values
  document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
    const col = +dropdown.dataset.col;
    const values = getUniqueColumnValues(col);
    values.forEach(val => {
      if (val && !dropdown.querySelector(`option[value="${val}"]`)) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        dropdown.appendChild(opt);
      }
    });
  });

  // Multi-column filtering
  function filterTable() {
    const filters = Array.from(document.querySelectorAll('.filter-dropdown')).map(sel => sel.value);
    table.querySelectorAll('tbody tr').forEach(tr => {
      let show = true;
      filters.forEach((val, idx) => {
        if (val && tr.children[idx].textContent.trim() !== val) show = false;
      });
      tr.style.display = show ? '' : 'none';
    });
  }
  document.querySelectorAll('.filter-dropdown').forEach(sel => {
    sel.addEventListener('change', filterTable);
  });

  // Tablesort custom sortTable for arrow click
  Tablesort.sortTable = function(table, colIdx, asc) {
    const th = table.querySelectorAll('th.sortable')[colIdx];
    if (th) {
      th.click();
      if ((asc && th.classList.contains('desc')) || (!asc && th.classList.contains('asc'))) {
        th.click();
      }
    }
  };
</script>
{% endblock %}
